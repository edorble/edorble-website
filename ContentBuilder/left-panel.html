<html lang="en-US">
<head>
    <meta charset="utf-8" />
        <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
    <META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE">

	<link rel="stylesheet" type="text/css" href="css/core.css" />

	<script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
	<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="js/coherent.js"></script>
	<script type="text/javascript">

		var fb = new Firebase("https://edorble-dev.firebaseio.com/");
		
		var WorldcodeId = ""; // current worldcode
		var MapId = ""; // current MapId
		var RegionId = ""; //current region code
		var ScreenId = ""; // unique num of the screen in WorldcodeId
	
		var linksData = new Array(); // linksData[id] -> JSON data for right panel, Unity will not parse this array and sends it tio the right panel as-is
		linksData[0] = '["iconLink", "Title", "Description"]';
		linksData[1] = '["iconVideo", "Title", "Description"]';
		linksData[2] = '["iconPicture", "Title", "Description"]';
		linksData[3] = '["iconAssessment", "Title", "Description"]';
		linksData[4] = '["iconPresentation", "Title", "Description"]';
		
		var links = new Object(); // contains relation links[id] -> URL for webscreen
		
		function LoadLinksFromFireBase(worldcodeId, mapId, regionId, screenId)
		{
			console.log( "Loading links from firebase: " + worldcodeId + ", screen " + screenId);
			
			//Fill links from firebase
			fb.child('worldContent/' + worldcodeId 
										//+ '/Maps/' + mapId 
										+ '/Regions/' + regionId 
										+ '/Screens/' + screenId 
										+ '/links' ).once("value", function(snap) {   
											
											var theLinks = snap.val()
										
											console.log(theLinks);
											console.log(theLinks.linkOne.Url);
								
											if(theLinks.linkOne != null)
											{
												if(theLinks.linkOne.Url != null) 
													{ 
														links[0] = theLinks.linkOne.Url; 
													};
													
													linksData[0] = theLinks.linkOne;
											}
			
			//if(theLinks.linkTwo.Url != null) { links[1] = theLinks.linkTwo.Url; };
			//if(theLinks.linkThree.Url != null) { links[2] = theLinks.linkThree.Url; };
			//if(theLinks.linkFour.Url != null) { links[3] = theLinks.linkFour.Url; };
			//if(theLinks.linkFive.Url != null) { links[4] = theLinks.linkFive.Url; };
			
			//testing
			console.log("first Link: " + links[0]);
			consle.log("first data: " + linksData[0];);
			
			//I think this part has to move to right panel and updating as well for editing
			//linksData[0] = '[' + theLinks.child('linkOne').Type + ',' + theLinks.child('linkOne').title + ',' + theLinks.child('linkOne').Description + ']';
			//linksData[1] = '[' + theLinks.child('linkTwo').Type + ',' + theLinks.child('linkTwo').title + ',' + theLinks.child('linkTwo').Description + ']';
			//linksData[2] = '[' + theLinks.child('linkThree').Type + ',' + theLinks.child('linkThree').title + ',' + theLinks.child('linkThree').Description + ']';
			//linksData[3] = '[' + theLinks.child('linkFour').Type + ',' + theLinks.child('linkFour').title + ',' + theLinks.child('linkFour').Description + ']';
			//linksData[4] = '[' + theLinks.child('linkFive').Type + ',' + theLinks.child('linkFive').title + ',' + theLinks.child('linkFive').Description + ']';
			
			});
			
			//testing
			console.log("first Data JSON: " + linksData[0]);
		}
		
		$(document).ready(function() {
		
			$(".destination").mouseup(
				function (event)
				{
					var id = event.target.id; // it is the same as link id
					engine.trigger('OnDestinationUP', id);						
				}
			);

			$(".destination").mousedown(
				function (event)
				{
					var id = event.target.id; // it is the same as link id
					engine.trigger('OnLinkDown', id);						
				}
			);
			
			$(".destination").click(
				function (event)
				{
					var id = event.target.id; // it is the same as link id
					if (links.hasOwnProperty(id)) 
					{
						//console.log( "objId " + id + ", " + links[id]);
						engine.trigger('OnLinkClicked', links[id], id, linksData[Math.floor(Math.random() * linksData.length)]);
					}
				}
			);
			
			$("#Exit").click(
				function (event)
				{
					engine.trigger('OnExitWebcastClicked');
				}
			);
			
			//for debugging
			LoadLinksFromFireBase("greenscene","greenscene",1,1);
			
		});
		
		engine.on("OnReceiveData", function (id, url)
		{
			console.log( "OnReceiveData " + id + ", url " +  url);		
			links[id] = url;
			
			var obj = $("#" + id);			
			obj.removeClass("iconAdd");
			obj.removeClass("iconLink");
			obj.addClass("iconLink");
			
			StoreScreenLinkToFirebase(id, url);
		});

		engine.on("OnLinkCleared", function (id)
		{
			console.log( "OnLinkCleared " + id );
			if (links.hasOwnProperty(id))
			{
				delete links[id];				
			}
			
			var obj = $("#" + id);			
			obj.removeClass("iconAdd");
			obj.removeClass("iconLink");
			obj.addClass("iconAdd");
			
			RemoveScreenLink(id);
		});

		// Unity sends there data just after interface is finished loading in Unity
		engine.on("OnBackendReady", function (worldcodeId, regionId, screenId)
		{
			console.log( "OnBackendReady LP: " + worldcodeId + ", screen " + screenId);
			WorldcodeId = worldcodeId;
			MapId = "greenscene" //TODO Dmitrii please add MapID
			RegionId = regionId;
			ScreenId = screenId;
			
			LoadLinksFromFireBase(WorldcodeId, MapId, RegionId, ScreenId)
		});
		
		function StoreScreenLinkToFirebase(id, url)
		{
			var linkName = "";
			// insert them to the Firebase, use WorldcodeId and ScreenId
			if(id == 0) linkName = 'linkOne';
			if(id == 1) linkName = 'linkTwo';
			if(id == 2) linkName = 'linkThree';
			if(id == 3) linkName = 'linkFour';
			if(id == 4) linkName = 'linkFive';
			
			fb.child('worldContent/' + WorldcodeId 
										+ 'worldMap/' + MapId 
										+ '/Regions/' + RegionId 
										+ '/Screens/' + ScreenId
				 						+ '/links/'+ linkName + 'url').set(url);
		}

		function RemoveScreenLink(id)
		{
			var linkName = "";
			// insert them to the Firebase, use WorldcodeId and ScreenId
			if(id == 0) linkName = 'linkOne';
			if(id == 1) linkName = 'linkTwo';
			if(id == 2) linkName = 'linkThree';
			if(id == 3) linkName = 'linkFour';
			if(id == 4) linkName = 'linkFive';
			
			// remove it from the Firebase, use WorldcodeId and ScreenId
			fb.child('worldContent/' + WorldcodeId 
								+ 'worldMap/' + MapId 
								+ '/Regions/' + RegionId 
								+ '/Screens/' + ScreenId
	 							+ '/links/'+ linkName).remove();
		}
		
		//$.storage('clear'); //clear coherent cache, needs only during developing
		
	</script>	
</head>
<body>
<table id="links">
<tr><td id="d1" class="destination iconAdd"></td></tr>
<tr><td id="d2" class="destination iconAdd"></td></tr>
<tr><td id="d3" class="destination iconAdd"></td></tr>
<tr><td id="d4" class="destination iconAdd"></td></tr>
<tr><td id="d5" class="destination iconAdd"></td></tr>
<tr><td id="d6" class="destination iconAdd"></td></tr>
<tr><td id="Exit" class="iconExitWebcast"></td></tr>
</table>
</body>
</html>
